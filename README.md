# Описание

## Авторизация - для api предусмотрен тип авторизации basic+e, для  proxy_adapter - token.
## Для пользования сервисом необходимо поместить client_id, client_secret и токен бота сервера дискорд в конфигурационный файл discord_bot.json. 
## Также, в конфигурационный файл jwt_auth.json необходимо добавить параметр salt. Значение установить латиницей из 16 символов.
## В конфигурационный файл service_param_key.json необходимо добавить discord_server_url - адрес самого сервера дискорд, redirect_url_if_reject_auth - страница на которую требуется направить пользователя, если тот отказался от аутентификации.
## Инструкция по созданию Discord бота - https://docs.google.com/document/d/1Bwl2cHYDQvfRIYB3k4GTve-_hKyyJIa4lsM5WDFDUSg/edit

# Добавление пользователя на сервер

## url - GET /api/discord/add_user_to_server?employee_id=1029871

### Выходные данные

```json
{
  "data": "https://discord.com/oauth2/authorize?client_id=1221119896671227954&redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fapi%2Fdiscord%2Fapi_call_back&response_type=code&scope=identify+guilds.join&state=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3YldOV0N5UEwwaE1zUDVCMkZqdXpSVmIxOFdGcytrPSJ9.3c0UKMUJaHoAjjN9W0XhMhJeLLIAhpcBTC2BTzXCAyw"
}
```

## Описание ручки

### Данный роут возвращает ссылку, на которою должен быть перенаправлен пользователь. Переходя по ссылке, пользователю будет предложено пройти OAUTH2 аутентификацию.
### В случае прохождения аутентификации пользователем, данные о пользователе будут направлены на эту ручку - /api/discord/api_call_back, которая принимает только 2 параметра - "code" и "state". Параметр "code" - код авторизации пользователя прошедшего oauth2 аутентификацию, в дальнейшем используем, чтобы обменять его на "access token" пользователя, необходимый для добавления пользователя на сервер, а также, чтобы получить информацию о самом пользователе.
### Также, нам дополнительно возвращается параметр "state" (макс. длина 600 символов). Немного поподробнее про этот параметр:
### Данный параметр генерится на бэке и возвращается в ссылке пользователю (выше пример), далее его же мы получаем обратно в /api/discord/api_call_back. Это jwt-токен, в котором закодирован 1 параметр - "employee_id". Возвращённый параметр "state" дэшифруется, и мы получаем "employee_id", того сотрудника, который переходил по ссылке выше. 
### После этого, по employee_id методом GET, используя данную ручку - https://wh-hard01.kol.wb.ru/wh-tech/wh-tech-back/-/blob/master/wh_tech_web_api/apis.yaml?ref_type=heads#L1341, также мы получаем ФИО сотрудника и приводим к ФИ.
### Таким образом, в случае, если пользователя на сервере нет, он будет добавлен. Вместе с этим ему будут выданы роли по дефолту ( _wh, __wh, prodpanic, employee sync bot verified), а также сотруднику будет присвоено имя на сервере.

### Примечание:
### Сформированной ссылкой для прохождения аутентификации ни с кем делиться нельзя, тк в ней зашифрованны данные о самом сотруднике с нашего портала (employee_id).

### После всех операций происходит редирект пользователя на наш сервер.


# Забанить пользователя сервера

## url - POST /api/discord/ban_member?employee_id=1029871

### Входные данные

### Тело запроса:
```json
{
  "user_id": "2",
  "reason": "Уволился по собственному желанию"
}
```

### Параметр "reason" опционален. Максимальная длина - 512 символов.


# Удалить пользователя с сервера

## url - POST /api/discord/kick_member?employee_id=1029871

### Входные данные

### Тело запроса:
```json
{
  "user_id": "3",
  "reason": "Уволился по собственному желанию"
}
```

### Параметр "reason" опционален. Максимальная длина - 512 символов.

### Возможные ошибки:
```
{
    "errors": [
      {
        "error": "internal.service_error",
        "message": "internal service error",
        "detail": "kick member error"
      }
    ]
}
```
### В случае успеха ничего не возвращается. Статус - 204.

# Проверка валидности токена бота
## url - GET /api/discord/check_valid_token
### В случае успеха ничего не возвращается. Статус - 204.
